<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz - Nextpulse</title>
  <link rel="stylesheet" href="../../styles.css">
  <link rel="stylesheet" href="../quiz-styles.css">
  <link rel="stylesheet" href="brain-styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="../../access-control.js"></script>
  <script src="../../block.js"></script>
  <script src="../../error-handler/link-checker.js"></script>
  <style>
    .file-selector {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .file-selector h3 {
      margin-bottom: 1rem;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .file-list {
      display: grid;
      gap: 0.75rem;
      max-height: 400px;
      overflow-y: auto;
    }
    .file-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      background: #f7fafc;
      border-radius: 10px;
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
    }
    .file-item:hover {
      background: #edf2f7;
      border-color: #cbd5e0;
    }
    .file-item .file-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #2c5282 0%, #3182ce 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1rem;
      flex-shrink: 0;
    }
    .file-item .file-info {
      flex: 1;
      min-width: 0;
    }
    .file-item .file-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: #2d3748;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-item .file-meta {
      font-size: 0.8rem;
      color: #718096;
      margin-top: 2px;
    }
    .file-item .start-btn {
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(56, 161, 105, 0.3);
    }
    .file-item .start-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(56, 161, 105, 0.4);
    }
    .file-item .start-btn:active {
      transform: translateY(0);
    }
    .file-item .start-btn i {
      font-size: 0.75rem;
    }
    
    /* Mode Selection Modal */
    .mode-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .mode-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .mode-modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px) scale(0.95);
      transition: all 0.3s ease;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }
    .mode-modal-overlay.active .mode-modal {
      transform: translateY(0) scale(1);
    }
    .mode-modal-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .mode-modal-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .mode-modal-header .close-modal-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: #f7fafc;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #718096;
      transition: all 0.2s;
    }
    .mode-modal-header .close-modal-btn:hover {
      background: #e2e8f0;
      color: #2d3748;
    }
    .mode-modal-body {
      padding: 1.5rem;
    }
    .mode-modal-topic {
      background: #f7fafc;
      padding: 0.875rem 1rem;
      border-radius: 10px;
      margin-bottom: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .mode-modal-topic i {
      color: #2c5282;
      font-size: 1.1rem;
    }
    .mode-modal-topic span {
      font-weight: 600;
      color: #2d3748;
      font-size: 0.95rem;
    }
    .mode-modal-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .mode-modal-option {
      padding: 1rem 1.25rem;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .mode-modal-option:hover {
      border-color: #2c5282;
      background: #f7fafc;
    }
    .mode-modal-option.selected {
      border-color: #2c5282;
      background: #ebf4ff;
    }
    .mode-modal-option .mode-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      flex-shrink: 0;
    }
    .mode-modal-option.normal-mode .mode-icon {
      background: linear-gradient(135deg, #3182ce 0%, #63b3ed 100%);
      color: white;
    }
    .mode-modal-option.test-mode .mode-icon {
      background: linear-gradient(135deg, #d69e2e 0%, #ecc94b 100%);
      color: white;
    }
    .mode-modal-option .mode-content {
      flex: 1;
    }
    .mode-modal-option .mode-title {
      font-weight: 600;
      font-size: 1rem;
      color: #2d3748;
      margin-bottom: 0.25rem;
    }
    .mode-modal-option .mode-desc {
      font-size: 0.8rem;
      color: #718096;
      line-height: 1.4;
    }
    .mode-modal-option .mode-check {
      width: 24px;
      height: 24px;
      border: 2px solid #cbd5e0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .mode-modal-option.selected .mode-check {
      background: #38a169;
      border-color: #38a169;
    }
    .mode-modal-footer {
      padding: 1rem 1.5rem 1.5rem;
    }
    .mode-modal-start-btn {
      width: 100%;
      padding: 0.875rem 1.5rem;
      background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(56, 161, 105, 0.3);
    }
    .mode-modal-start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(56, 161, 105, 0.4);
    }
    .mode-modal-start-btn:active {
      transform: translateY(0);
    }
    
    /* Mobile Responsive for Modal */
    @media (max-width: 480px) {
      .mode-modal {
        max-width: 100%;
        margin: 0.5rem;
        border-radius: 12px;
      }
      .mode-modal-header {
        padding: 1rem 1.25rem;
      }
      .mode-modal-body {
        padding: 1.25rem;
      }
      .mode-modal-option {
        padding: 0.875rem 1rem;
      }
      .mode-modal-option .mode-icon {
        width: 42px;
        height: 42px;
        font-size: 1.1rem;
      }
      .mode-modal-footer {
        padding: 0.875rem 1.25rem 1.25rem;
      }
      .file-item {
        padding: 0.75rem;
        gap: 0.6rem;
      }
      .file-item .file-icon {
        width: 36px;
        height: 36px;
        font-size: 0.9rem;
      }
      .file-item .file-name {
        font-size: 0.9rem;
      }
      .file-item .start-btn {
        padding: 0.45rem 0.75rem;
        font-size: 0.8rem;
      }
      .file-item .start-btn span {
        display: none;
      }
    }
    .start-quiz-btn {
      width: 100%;
      padding: 1rem;
      background: #38a169;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1rem;
      transition: all 0.3s;
    }
    .start-quiz-btn:hover {
      background: #2f855a;
    }
    .start-quiz-btn:disabled {
      background: #a0aec0;
      cursor: not-allowed;
    }
    .question-html-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .explanation-html-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 1rem 0;
    }
    
    /* Global Search Bar */
    .global-search-container {
      margin-bottom: 1.5rem;
    }
    .global-search-bar {
      background: white;
      border-radius: 25px;
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .global-search-bar i {
      color: #718096;
      margin-right: 0.75rem;
    }
    .global-search-bar input {
      background: none;
      border: none;
      outline: none;
      width: 100%;
      font-size: 1rem;
      color: #2d3748;
    }
    .search-results {
      margin-top: 0.75rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }
    .search-results.active {
      display: block;
    }
    .search-result-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .search-result-item:hover {
      background: #f7fafc;
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-result-item i {
      color: #2c5282;
    }
    .search-result-item .result-title {
      font-weight: 500;
      color: #2d3748;
    }
    .search-result-item .result-path {
      font-size: 0.8rem;
      color: #718096;
    }
    
    /* Mode Selector */
    .mode-selector {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .mode-selector h3 {
      margin-bottom: 1rem;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .mode-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    @media (max-width: 480px) {
      .mode-options {
        grid-template-columns: 1fr;
      }
    }
    .mode-option {
      padding: 1.25rem;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    .mode-option:hover {
      border-color: #2c5282;
      background: #f7fafc;
    }
    .mode-option.selected {
      border-color: #2c5282;
      background: #2c5282;
      color: white;
    }
    .mode-option i {
      font-size: 2rem;
      margin-bottom: 0.75rem;
      display: block;
    }
    .mode-option .mode-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .mode-option .mode-desc {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    .mode-option.selected .mode-desc {
      opacity: 0.9;
    }
    
    /* Timer */
    .quiz-timer {
      position: fixed;
      top: 80px;
      right: 1rem;
      background: white;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      color: #2c5282;
    }
    .quiz-timer.warning {
      background: #fef3c7;
      color: #d97706;
    }
    .quiz-timer.danger {
      background: #fee2e2;
      color: #dc2626;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .quiz-timer i {
      font-size: 1.1rem;
    }
    
    /* Test Mode Styling */
    .test-mode-active .explanation-container,
    body.test-mode-active .explanation-container,
    body.test-mode-active #explanation-container {
      display: none !important;
    }
    .test-mode-active .option-btn.selected-test {
      background: #e2e8f0;
      border-color: #2c5282;
    }
    
    /* Horizontal Scroll for Explanations/Tables */
    .explanation-html-content,
    .question-html-content {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
    }
    .explanation-html-content table,
    .question-html-content table {
      min-width: 600px;
      display: block;
      overflow-x: auto;
    }
    .table-scroll-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: 1rem 0;
    }
    .table-scroll-wrapper table {
      min-width: 500px;
    }
    
    /* Mobile-Friendly Improvements */
    @media (max-width: 768px) {
      .quiz-timer {
        top: auto;
        bottom: 70px;
        right: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
      .file-selector,
      .mode-selector {
        padding: 1rem;
      }
      .file-item {
        padding: 0.875rem;
      }
      .mode-option {
        padding: 1rem;
      }
      .mode-option i {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <script>
    if (!accessControl.initProtectedPage()) {
      throw new Error('Access denied - redirecting to index.html');
    }
  </script>
  
  <header>
    <div class="header-content">
      <button onclick="goBackToFolder()" class="back-button" style="display: block;">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 id="pageTitle">Quiz</h1>
      <p class="header-subtitle" id="quizInfo">Loading...</p>
    </div>
  </header>

  <main>
    <div id="loading" class="loading-container">
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading questions...</p>
      </div>
    </div>

    <div id="file-selector-container" class="brain-main-container" style="display: none;">
      <!-- Global Search -->
      <div class="global-search-container">
        <div class="global-search-bar">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search all topics and articles..." id="globalSearchInput" oninput="handleGlobalSearch(event)">
        </div>
        <div class="search-results" id="searchResults"></div>
      </div>
      
      <div class="file-selector">
        <h3><i class="fas fa-file-alt"></i> Select a Topic</h3>
        <div class="file-list" id="fileList"></div>
      </div>
    </div>
    
    <!-- Mode Selection Modal -->
    <div class="mode-modal-overlay" id="modeModalOverlay" onclick="closeModeModal(event)">
      <div class="mode-modal" onclick="event.stopPropagation()">
        <div class="mode-modal-header">
          <h3><i class="fas fa-play-circle"></i> Start Quiz</h3>
          <button class="close-modal-btn" onclick="closeModeModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="mode-modal-body">
          <div class="mode-modal-topic">
            <i class="fas fa-file-alt"></i>
            <span id="modalTopicName">Topic Name</span>
          </div>
          <div class="mode-modal-options">
            <div class="mode-modal-option normal-mode selected" data-mode="normal" onclick="selectModalMode('normal')">
              <div class="mode-icon">
                <i class="fas fa-book-open"></i>
              </div>
              <div class="mode-content">
                <div class="mode-title">Normal Mode</div>
                <div class="mode-desc">See answers immediately with explanations</div>
              </div>
              <div class="mode-check">
                <i class="fas fa-check"></i>
              </div>
            </div>
            <div class="mode-modal-option test-mode" data-mode="test" onclick="selectModalMode('test')">
              <div class="mode-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="mode-content">
                <div class="mode-title">Test Mode</div>
                <div class="mode-desc">Timed quiz (1 min/question). Results at the end</div>
              </div>
              <div class="mode-check">
                <i class="fas fa-check"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="mode-modal-footer">
          <button class="mode-modal-start-btn" onclick="startQuizFromModal()">
            <i class="fas fa-play"></i> Start Quiz
          </button>
        </div>
      </div>
    </div>
    
    <!-- Timer for Test Mode -->
    <div id="quizTimer" class="quiz-timer" style="display: none;">
      <i class="fas fa-clock"></i>
      <span id="timerDisplay">00:00</span>
    </div>

    <div id="quiz-container" class="quiz-container" style="display: none;">
      <div class="question-container">
        <div class="quiz-progress" onclick="showQuestionNavigation()" style="cursor: pointer; user-select: none;" title="Click to navigate">
          <span id="current-question">1</span> / <span id="total-questions">1</span>
        </div>
        
        <button id="bookmark-btn" onclick="toggleBookmark()" class="bookmark-question-btn" title="Bookmark this question">
          <i class="far fa-bookmark"></i>
        </button>
        
        <div id="question-text" class="question-text question-html-content"></div>
        <div id="question-image" class="question-image" style="display: none;">
          <img id="question-img" src="" alt="Question Image">
        </div>
        
        <div id="options-container" class="options-container"></div>
      </div>

      <div id="explanation-container" class="explanation-container" style="display: none;">
        <h3>Explanation:</h3>
        <div id="explanation-text" class="explanation-html-content"></div>
        <div id="explanation-image" class="explanation-image" style="display: none;">
          <img id="explanation-img" src="" alt="Explanation Image">
        </div>
      </div>
    </div>

    <div id="error-container" class="error-container" style="display: none;">
      <div class="error-content">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>No Questions Available</h3>
        <p id="error-message">No questions found for this content.</p>
        <button onclick="goBackToFolder()" class="action-btn">Go Back</button>
      </div>
    </div>

    <div id="questionNavPopup" class="question-nav-popup" style="display: none;">
      <div class="popup-overlay" onclick="closeQuestionNavigation()"></div>
      <div class="popup-content">
        <div class="popup-header">
          <h3>Navigate to Question</h3>
          <button onclick="closeQuestionNavigation()" class="close-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="question-nav-grid" id="questionNavGrid"></div>
      </div>
    </div>
  </main>

  <script>
    let currentQuiz = null;
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let score = 0;
    let folderName = '';
    let folderPath = '';
    let pathString = '';
    let availableFiles = [];
    let selectedFileIndex = -1;
    let quizMode = 'normal'; // 'normal' or 'test'
    let timerInterval = null;
    let totalTimeSeconds = 0;
    let remainingTimeSeconds = 0;
    let allManifestFiles = []; // For global search
    
    // Cleanup function to reset quiz state
    function cleanupQuizState() {
      stopTimer();
      document.getElementById('quiz-container').classList.remove('test-mode-active');
      document.body.classList.remove('test-mode-active');
      document.getElementById('explanation-container').style.display = 'none';
    }
    
    // Timer functions
    function startTimer() {
      if (quizMode !== 'test' || !currentQuiz) return;
      
      // Clear any existing timer first
      stopTimer();
      
      // Compute fresh duration: 1 minute per question
      totalTimeSeconds = currentQuiz.length * 60;
      remainingTimeSeconds = totalTimeSeconds;
      
      document.getElementById('quizTimer').style.display = 'flex';
      document.getElementById('quiz-container').classList.add('test-mode-active');
      document.body.classList.add('test-mode-active');
      
      // Ensure explanation container is hidden in test mode
      document.getElementById('explanation-container').style.display = 'none';
      
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
        remainingTimeSeconds--;
        updateTimerDisplay();
        
        if (remainingTimeSeconds <= 0) {
          stopTimer();
          // Show time's up alert and auto-submit
          alert('Time is up! Submitting your answers.');
          finishTestMode();
        }
      }, 1000);
    }
    
    function updateTimerDisplay() {
      const minutes = Math.floor(remainingTimeSeconds / 60);
      const seconds = remainingTimeSeconds % 60;
      const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      document.getElementById('timerDisplay').textContent = display;
      
      const timerEl = document.getElementById('quizTimer');
      const percentRemaining = remainingTimeSeconds / totalTimeSeconds;
      
      timerEl.classList.remove('warning', 'danger');
      if (percentRemaining <= 0.1) {
        timerEl.classList.add('danger');
      } else if (percentRemaining <= 0.25) {
        timerEl.classList.add('warning');
      }
    }
    
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      document.getElementById('quizTimer').style.display = 'none';
      // Reset timer state
      remainingTimeSeconds = 0;
      totalTimeSeconds = 0;
    }
    
    function finishTestMode() {
      stopTimer();
      document.getElementById('quiz-container').classList.remove('test-mode-active');
      document.body.classList.remove('test-mode-active');
      
      // Calculate final score from test mode answers (only at submission)
      if (currentQuiz) {
        score = 0;
        currentQuiz.forEach((q, index) => {
          if (userAnswers[index] === q.correct_answer) {
            score++;
          }
        });
      }
      showQuizResults();
    }
    
    // Global Search
    async function loadManifestForSearch() {
      try {
        const response = await fetch('./file-manifest.json');
        if (response.ok) {
          const manifest = await response.json();
          allManifestFiles = [];
          
          if (manifest.folders) {
            for (const [folderPath, folderData] of Object.entries(manifest.folders)) {
              if (folderData.files && Array.isArray(folderData.files)) {
                folderData.files.forEach(fileName => {
                  allManifestFiles.push({
                    name: fileName.replace('.json', '').replace(/_/g, ' '),
                    path: `./${folderPath}/${fileName}`,
                    folderPath: folderPath,
                    type: folderData.type || 'quiz'
                  });
                });
              }
            }
          }
        }
      } catch (e) {
        console.log('Could not load manifest for search');
      }
    }
    
    function handleGlobalSearch(event) {
      const query = event.target.value.toLowerCase().trim();
      const resultsContainer = document.getElementById('searchResults');
      
      if (query.length < 2) {
        resultsContainer.classList.remove('active');
        return;
      }
      
      const filtered = allManifestFiles.filter(file => 
        file.name.toLowerCase().includes(query) ||
        file.folderPath.toLowerCase().includes(query)
      );
      
      if (filtered.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item"><span>No results found</span></div>';
        resultsContainer.classList.add('active');
        return;
      }
      
      resultsContainer.innerHTML = filtered.slice(0, 10).map(file => `
        <div class="search-result-item" onclick="openSearchResult('${encodeURIComponent(file.path)}', '${file.type}', '${encodeURIComponent(file.folderPath)}')">
          <i class="fas ${file.type === 'article' ? 'fa-file-medical-alt' : 'fa-question-circle'}"></i>
          <div>
            <div class="result-title">${file.name}</div>
            <div class="result-path">${file.folderPath}</div>
          </div>
        </div>
      `).join('');
      resultsContainer.classList.add('active');
    }
    
    function openSearchResult(path, type, folderPathEncoded) {
      const decodedPath = decodeURIComponent(path);
      const decodedFolderPath = decodeURIComponent(folderPathEncoded);
      const fileName = decodedPath.split('/').pop().replace('.json', '').replace(/_/g, ' ');
      
      if (type === 'article') {
        window.location.href = `article.html?folder=${encodeURIComponent(fileName)}&folderPath=${encodeURIComponent(decodedFolderPath)}`;
      } else {
        window.location.href = `quiz.html?folder=${encodeURIComponent(fileName)}&folderPath=${encodeURIComponent(decodedFolderPath)}`;
      }
    }

    function goBackToFolder() {
      if (pathString) {
        const pathParts = pathString.split(',');
        pathParts.pop();
        if (pathParts.length > 0) {
          window.location.href = `browse.html?path=${pathParts.join(',')}`;
        } else {
          window.location.href = 'index.html';
        }
      } else {
        window.location.href = 'index.html';
      }
    }

    async function loadQuiz() {
      const urlParams = new URLSearchParams(window.location.search);
      folderName = urlParams.get('folder') || '';
      folderPath = urlParams.get('folderPath') || '';
      pathString = urlParams.get('path') || '';

      if (!folderName) {
        showError('No content folder specified.');
        return;
      }

      document.getElementById('pageTitle').textContent = folderName;
      document.getElementById('quizInfo').textContent = 'Nextpulse Quiz';

      await findAndLoadQuestions();
    }

    async function findAndLoadQuestions() {
      let foundFiles = [];
      
      try {
        const manifestResponse = await fetch('./file-manifest.json');
        if (manifestResponse.ok) {
          const manifest = await manifestResponse.json();
          
          if (manifest.folders && folderPath && manifest.folders[folderPath]) {
            const folderData = manifest.folders[folderPath];
            foundFiles = folderData.files.map(fileName => ({
              name: fileName.replace('.json', '').replace(/_/g, ' '),
              path: `./${folderPath}/${fileName}`
            }));
          }
        }
      } catch (e) {
        console.log('Manifest not found, trying direct file access');
      }

      if (foundFiles.length === 0) {
        const possiblePaths = [];
        if (folderPath) {
          possiblePaths.push(`./${folderPath}/`);
        }
        const sanitizedName = folderName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
        possiblePaths.push(`./${folderName}/`);
        possiblePaths.push(`./${sanitizedName}/`);
        
        for (const basePath of possiblePaths) {
          try {
            const files = await scanForJsonFiles(basePath);
            if (files.length > 0) {
              foundFiles = files;
              break;
            }
          } catch (e) {
            console.log(`No files found at ${basePath}`);
          }
        }
      }

      if (foundFiles.length === 0) {
        const directJsonPaths = [
          `./${folderPath}.json`,
          `./${folderName}.json`,
          `./${folderName.replace(/\s+/g, '_')}.json`
        ];
        
        for (const jsonPath of directJsonPaths) {
          try {
            const response = await fetch(jsonPath);
            if (response.ok) {
              const data = await response.json();
              await processQuizData(data, jsonPath);
              return;
            }
          } catch (e) {
            console.log(`No file at ${jsonPath}`);
          }
        }
      }

      if (foundFiles.length === 1) {
        await loadQuizFromFile(foundFiles[0]);
      } else if (foundFiles.length > 1) {
        showFileSelector(foundFiles);
      } else {
        showError(`No quiz files found in folder: ${folderName}. Please upload JSON files to the ${folderPath || folderName} folder and update the file-manifest.json.`);
      }
    }

    async function scanForJsonFiles(basePath) {
      const files = [];
      
      const knownFiles = await getKnownJsonFiles(basePath);
      
      for (const fileName of knownFiles) {
        try {
          const fullPath = basePath + fileName;
          const response = await fetch(fullPath, { method: 'HEAD' });
          if (response.ok) {
            files.push({ name: fileName, path: fullPath });
          }
        } catch (e) {
        }
      }
      
      return files;
    }

    async function getKnownJsonFiles(basePath) {
      const urlParams = new URLSearchParams(window.location.search);
      const folderPath = urlParams.get('folderPath') || '';
      
      const testFiles = [];
      
      const commonPatterns = [
        'questions.json',
        'quiz.json',
        'data.json',
        'index.json'
      ];
      
      const pathParts = folderPath.split('/');
      const lastFolder = pathParts[pathParts.length - 1];
      if (lastFolder) {
        testFiles.push(`${lastFolder}.json`);
        testFiles.push(`${lastFolder.replace(/\s+/g, '_')}.json`);
      }
      
      return [...testFiles, ...commonPatterns];
    }

    function showFileSelector(files) {
      availableFiles = files;
      document.getElementById('loading').style.display = 'none';
      document.getElementById('file-selector-container').style.display = 'block';
      
      // Load manifest for global search
      loadManifestForSearch();
      
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = files.map((file, index) => {
        const displayName = file.name.replace(/.json$/, '').replace(/_/g, ' ');
        return `
          <div class="file-item" data-index="${index}">
            <div class="file-icon">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="file-info">
              <div class="file-name">${displayName}</div>
              <div class="file-meta">Quiz</div>
            </div>
            <button class="start-btn" onclick="openModeModal(${index})">
              <i class="fas fa-play"></i>
              <span>Start</span>
            </button>
          </div>
        `;
      }).join('');
    }

    // Modal Functions
    function openModeModal(index) {
      selectedFileIndex = index;
      const file = availableFiles[index];
      const displayName = file.name.replace(/.json$/, '').replace(/_/g, ' ');
      
      document.getElementById('modalTopicName').textContent = displayName;
      document.getElementById('modeModalOverlay').classList.add('active');
      
      // Reset to normal mode by default
      selectModalMode('normal');
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = 'hidden';
    }
    
    function closeModeModal(event) {
      // If event exists and target is not the overlay, don't close
      if (event && event.target !== event.currentTarget) return;
      
      document.getElementById('modeModalOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }
    
    function selectModalMode(mode) {
      quizMode = mode;
      document.querySelectorAll('.mode-modal-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.mode === mode);
      });
    }
    
    async function startQuizFromModal() {
      if (selectedFileIndex < 0 || !availableFiles[selectedFileIndex]) return;
      
      // Close modal
      closeModeModal();
      
      // Cleanup any previous quiz state before starting
      cleanupQuizState();
      
      document.getElementById('file-selector-container').style.display = 'none';
      document.getElementById('loading').style.display = 'block';
      
      await loadQuizFromFile(availableFiles[selectedFileIndex]);
    }

    async function loadQuizFromFile(fileInfo) {
      try {
        const response = await fetch(fileInfo.path);
        if (!response.ok) {
          throw new Error('Failed to load file');
        }
        const data = await response.json();
        await processQuizData(data, fileInfo.path);
      } catch (error) {
        console.error('Error loading quiz:', error);
        showError(`Failed to load quiz from: ${fileInfo.name}`);
      }
    }

    async function processQuizData(data, sourcePath) {
      let questions = [];
      
      if (data.questions && Array.isArray(data.questions)) {
        questions = data.questions.map(normalizeQuestion);
      } else if (Array.isArray(data)) {
        questions = data.map(normalizeQuestion);
      } else {
        throw new Error('Invalid quiz data format');
      }

      if (questions.length === 0) {
        showError('No questions found in the quiz file.');
        return;
      }

      currentQuiz = questions;
      currentQuestionIndex = 0;
      userAnswers = new Array(currentQuiz.length).fill(null);
      score = 0;
      loadQuestion();
      
      // Start timer if in test mode
      if (quizMode === 'test') {
        startTimer();
      }
    }

    function normalizeQuestion(q, index) {
      if (q.choices && Array.isArray(q.choices)) {
        const options = {};
        const optionLabels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
        let correctAnswer = '';
        
        q.choices.forEach((choice, i) => {
          const label = optionLabels[i] || String(i + 1);
          options[label] = stripHtml(choice.text || choice);
          
          if (choice.id === q.correct_choice_id) {
            correctAnswer = label;
          }
        });
        
        return {
          q_no: q.id || index + 1,
          question: stripHtml(q.text || q.question || ''),
          options: options,
          correct_answer: correctAnswer,
          explanation: q.solution || q.explanation || '',
          image: extractImageFromHtml(q.text) || (q.question_images && q.question_images[0]) || null,
          explanation_image: extractImageFromHtml(q.solution) || (q.explanation_images && q.explanation_images[0]) || null,
          tags: q.tags || [],
          difficulty: q.difficulty_level || 'intermediate'
        };
      }
      
      if (q.options && typeof q.options === 'object') {
        return {
          q_no: q.q_no || q.id || index + 1,
          question: q.question || '',
          options: q.options,
          correct_answer: q.correct_answer || '',
          explanation: q.explanation || '',
          image: q.image || null,
          explanation_image: q.explanation_image || null,
          tags: q.tags || [],
          difficulty: q.difficulty || 'intermediate'
        };
      }
      
      return q;
    }

    function stripHtml(html) {
      if (!html) return '';
      const temp = document.createElement('div');
      temp.innerHTML = html;
      return temp.textContent || temp.innerText || '';
    }

    function extractImageFromHtml(html) {
      if (!html) return null;
      const match = html.match(/<img[^>]+src=["']([^"']+)["']/i);
      return match ? match[1] : null;
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('file-selector-container').style.display = 'none';
      document.getElementById('error-container').style.display = 'block';
      document.getElementById('error-message').textContent = message;
    }

    function loadQuestion() {
      if (!currentQuiz || currentQuiz.length === 0) return;

      document.getElementById('loading').style.display = 'none';
      document.getElementById('file-selector-container').style.display = 'none';
      document.getElementById('quiz-container').style.display = 'block';
      document.getElementById('error-container').style.display = 'none';

      const question = currentQuiz[currentQuestionIndex];
      document.getElementById('current-question').textContent = currentQuestionIndex + 1;
      document.getElementById('total-questions').textContent = currentQuiz.length;
      
      document.getElementById('question-text').innerHTML = `<strong>Q${question.q_no || (currentQuestionIndex + 1)}.</strong> ${question.question}`;

      const questionImageDiv = document.getElementById('question-image');
      const questionImg = document.getElementById('question-img');
      if (question.image) {
        questionImg.src = question.image;
        questionImageDiv.style.display = 'block';
      } else {
        questionImageDiv.style.display = 'none';
      }

      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';

      if (question.options) {
        Object.entries(question.options).forEach(([key, value]) => {
          const button = document.createElement('button');
          button.className = 'option-btn';
          
          // In test mode, show previously selected answer
          if (quizMode === 'test' && userAnswers[currentQuestionIndex] === key) {
            button.classList.add('selected-test');
          }
          
          button.onclick = () => selectOption(key, button);
          button.innerHTML = `
            <span class="option-label">${key}</span>
            <span>${value}</span>
          `;
          optionsContainer.appendChild(button);
        });
      }

      // Always hide explanation when loading a new question
      document.getElementById('explanation-container').style.display = 'none';
      
      // Defensive: Ensure test mode classes are maintained during quiz
      if (quizMode === 'test') {
        document.body.classList.add('test-mode-active');
        document.getElementById('quiz-container').classList.add('test-mode-active');
      }
      
      updateBookmarkButton();
      
      // In test mode, add navigation buttons
      if (quizMode === 'test') {
        addTestModeNavigation();
      }
    }
    
    function addTestModeNavigation() {
      const quizContainer = document.getElementById('quiz-container');
      
      // Remove existing navigation if any
      const existingNav = quizContainer.querySelector('.test-mode-nav');
      if (existingNav) existingNav.remove();
      
      const navContainer = document.createElement('div');
      navContainer.className = 'test-mode-nav';
      navContainer.style.cssText = 'display: flex; justify-content: space-between; gap: 1rem; padding: 1rem; margin-top: 1rem;';
      
      const prevBtn = document.createElement('button');
      prevBtn.className = 'nav-btn secondary';
      prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> Previous';
      prevBtn.style.cssText = 'flex: 1; padding: 0.75rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; background: #e2e8f0; color: #2d3748;';
      prevBtn.disabled = currentQuestionIndex === 0;
      prevBtn.onclick = () => {
        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          loadQuestion();
        }
      };
      
      const nextBtn = document.createElement('button');
      nextBtn.className = 'nav-btn primary';
      nextBtn.style.cssText = 'flex: 1; padding: 0.75rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; background: #2c5282; color: white;';
      
      if (currentQuestionIndex === currentQuiz.length - 1) {
        nextBtn.innerHTML = '<i class="fas fa-check"></i> Finish Quiz';
        nextBtn.onclick = finishTestMode;
      } else {
        nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
        nextBtn.onclick = () => {
          currentQuestionIndex++;
          loadQuestion();
        };
      }
      
      navContainer.appendChild(prevBtn);
      navContainer.appendChild(nextBtn);
      quizContainer.appendChild(navContainer);
    }

    function selectOption(selectedOption, buttonElement) {
      const question = currentQuiz[currentQuestionIndex];
      const correctAnswer = question.correct_answer;
      
      userAnswers[currentQuestionIndex] = selectedOption;
      
      if (quizMode === 'test') {
        // Test mode: just mark selection visually, NO SCORING until end
        const allOptions = document.querySelectorAll('.option-btn');
        allOptions.forEach(btn => {
          btn.classList.remove('selected-test');
          const optionLabel = btn.querySelector('.option-label').textContent;
          if (optionLabel === selectedOption) {
            btn.classList.add('selected-test');
          }
        });
        
        // Ensure explanation remains hidden in test mode
        document.getElementById('explanation-container').style.display = 'none';
        
        // Do NOT auto-navigate, let user use navigation buttons
        // This allows them to review/change answers
        return; // Exit early - no scoring in test mode during selection
      }
      
      // Normal mode only: show correct/incorrect and explanation
      const allOptions = document.querySelectorAll('.option-btn');
      allOptions.forEach(btn => {
        btn.disabled = true;
        btn.onclick = null;
      });
      
      allOptions.forEach(btn => {
        const optionLabel = btn.querySelector('.option-label').textContent;
        if (optionLabel === correctAnswer) {
          btn.classList.add('correct');
        } else if (optionLabel === selectedOption && selectedOption !== correctAnswer) {
          btn.classList.add('incorrect');
        }
      });
      
      // Normal mode scoring
      if (selectedOption === correctAnswer) {
        score++;
      }
      
      setTimeout(() => {
        showExplanation();
      }, 800);
    }

    function showExplanation() {
      const question = currentQuiz[currentQuestionIndex];
      const explanationContainer = document.getElementById('explanation-container');
      const explanationText = document.getElementById('explanation-text');
      const explanationImageDiv = document.getElementById('explanation-image');
      const explanationImg = document.getElementById('explanation-img');
      
      explanationText.innerHTML = question.explanation || 'No explanation available.';
      
      if (question.explanation_image) {
        explanationImg.src = question.explanation_image;
        explanationImageDiv.style.display = 'block';
      } else {
        explanationImageDiv.style.display = 'none';
      }
      
      explanationContainer.style.display = 'block';
      
      const existingButtons = explanationContainer.querySelectorAll('.next-btn, .finish-btn');
      existingButtons.forEach(btn => btn.remove());
      
      const buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = 'text-align: center; margin-top: 2rem;';
      
      const nextBtn = document.createElement('button');
      nextBtn.className = currentQuestionIndex === currentQuiz.length - 1 ? 'finish-btn' : 'next-btn';
      nextBtn.style.cssText = 'background: #16a34a; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease;';
      nextBtn.innerHTML = currentQuestionIndex === currentQuiz.length - 1 ? 
        '<i class="fas fa-check"></i> Finish Quiz' : 
        '<i class="fas fa-arrow-right"></i> Next Question';
      nextBtn.onclick = nextQuestion;
      
      buttonContainer.appendChild(nextBtn);
      explanationContainer.appendChild(buttonContainer);
    }

    function nextQuestion() {
      if (currentQuestionIndex < currentQuiz.length - 1) {
        currentQuestionIndex++;
        loadQuestion();
      } else {
        showQuizResults();
      }
    }

    function showQuizResults() {
      const resultsData = {
        questions: currentQuiz,
        userAnswers: userAnswers,
        score: score,
        total: currentQuiz.length,
        platform: 'brain',
        subject: folderName,
        chapter: folderName
      };
      localStorage.setItem('quizResultsData', JSON.stringify(resultsData));
      
      window.location.href = `results.html?folder=${encodeURIComponent(folderName)}&path=${pathString}&score=${score}&total=${currentQuiz.length}`;
    }

    function toggleBookmark() {
      if (!currentQuiz) return;
      
      const question = currentQuiz[currentQuestionIndex];
      
      const saved = localStorage.getItem('quizBookmarks');
      let bookmarks = saved ? JSON.parse(saved) : [];
      
      const bookmarkData = {
        ...question,
        platform: 'brain',
        subject: folderName,
        bookmarkedAt: new Date().toISOString()
      };
      
      const existingIndex = bookmarks.findIndex(bookmark => 
        bookmark.q_no === question.q_no && 
        bookmark.platform === 'brain' && 
        bookmark.subject === folderName
      );
      
      const bookmarkBtn = document.getElementById('bookmark-btn');
      const bookmarkIcon = bookmarkBtn.querySelector('i');
      
      if (existingIndex > -1) {
        bookmarks.splice(existingIndex, 1);
        bookmarkIcon.className = 'far fa-bookmark';
      } else {
        bookmarks.push(bookmarkData);
        bookmarkIcon.className = 'fas fa-bookmark';
      }
      
      localStorage.setItem('quizBookmarks', JSON.stringify(bookmarks));
    }

    function updateBookmarkButton() {
      if (!currentQuiz) return;
      
      const question = currentQuiz[currentQuestionIndex];
      
      const saved = localStorage.getItem('quizBookmarks');
      const bookmarks = saved ? JSON.parse(saved) : [];
      
      const isBookmarked = bookmarks.some(bookmark => 
        bookmark.q_no === question.q_no && 
        bookmark.platform === 'brain' && 
        bookmark.subject === folderName
      );
      
      const bookmarkIcon = document.getElementById('bookmark-btn').querySelector('i');
      bookmarkIcon.className = isBookmarked ? 'fas fa-bookmark' : 'far fa-bookmark';
    }

    function showQuestionNavigation() {
      if (!currentQuiz || currentQuiz.length === 0) return;
      
      const popup = document.getElementById('questionNavPopup');
      const grid = document.getElementById('questionNavGrid');
      
      grid.innerHTML = '';
      
      for (let i = 0; i < currentQuiz.length; i++) {
        const questionBtn = document.createElement('button');
        questionBtn.className = 'question-nav-btn';
        questionBtn.textContent = i + 1;
        
        if (i === currentQuestionIndex) {
          questionBtn.classList.add('current');
        }
        
        if (userAnswers[i] !== null) {
          questionBtn.classList.add('answered');
        }
        
        questionBtn.onclick = () => {
          navigateToQuestion(i);
          closeQuestionNavigation();
        };
        
        grid.appendChild(questionBtn);
      }
      
      popup.style.display = 'flex';
    }

    function closeQuestionNavigation() {
      document.getElementById('questionNavPopup').style.display = 'none';
    }

    function navigateToQuestion(questionIndex) {
      if (questionIndex >= 0 && questionIndex < currentQuiz.length) {
        currentQuestionIndex = questionIndex;
        loadQuestion();
      }
    }

    window.addEventListener('load', loadQuiz);
  </script>
</body>
</html>
